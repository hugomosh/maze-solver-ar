var I=Object.defineProperty;var C=(s,t,e)=>t in s?I(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var x=(s,t,e)=>C(s,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function e(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(n){if(n.ep)return;n.ep=!0;const r=e(n);fetch(n.href,r)}})();let R=null;async function A(){const s=document.getElementById("video"),t=document.getElementById("overlay");try{const e={video:{width:{ideal:1280},height:{ideal:720},facingMode:"environment"}};return R=await navigator.mediaDevices.getUserMedia(e),s.srcObject=R,new Promise(i=>{s.onloadedmetadata=()=>{t.width=s.videoWidth,t.height=s.videoHeight,i()}})}catch{throw new Error("Camera access denied or not available")}}function b(){const s=document.getElementById("video"),t=document.createElement("canvas"),e=t.getContext("2d");if(!e)throw new Error("Could not get canvas context");return t.width=s.videoWidth,t.height=s.videoHeight,e.drawImage(s,0,0,t.width,t.height),{imageData:e.getImageData(0,0,t.width,t.height),width:t.width,height:t.height}}class D{detectMaze(t){return{grid:this.convertToBinary(t),width:t.width,height:t.height}}convertToBinary(t){const{width:e,height:i,imageData:n}=t,r=Array(i).fill(0).map(()=>Array(e).fill(!1)),o=n.data,c=this.calculateThreshold(o);for(let d=0;d<i;d++)for(let f=0;f<e;f++){const a=(d*e+f)*4,h=(o[a]+o[a+1]+o[a+2])/3;r[d][f]=h>c}return r}calculateThreshold(t){const e=new Array(256).fill(0);for(let a=0;a<t.length;a+=4){const h=Math.round((t[a]+t[a+1]+t[a+2])/3);e[h]++}const i=t.length/4;let n=0;for(let a=0;a<256;a++)n+=a*e[a];let r=0,o=0,c=0,d=0,f=0;for(let a=0;a<256;a++){if(o+=e[a],o===0)continue;if(c=i-o,c===0)break;r+=a*e[a];const h=r/o,y=(n-r)/c,u=o*c*(h-y)*(h-y);u>d&&(d=u,f=a)}return f}}class N{solveMaze(t){if(!t.start||!t.end)return{path:[],found:!1};const e=Math.round(t.start.x),i=Math.round(t.start.y),n=Math.round(t.end.x),r=Math.round(t.end.y);if(!this.isValidPoint(t,e,i)||!this.isValidPoint(t,n,r))return{path:[],found:!1};const o=[{x:e,y:i,path:[{x:e,y:i}]}],c=Array(t.height).fill(0).map(()=>Array(t.width).fill(!1));c[i][e]=!0;const d=[{dx:1,dy:0},{dx:0,dy:1},{dx:-1,dy:0},{dx:0,dy:-1}];for(;o.length>0;){const{x:f,y:a,path:h}=o.shift();if(f===n&&a===r)return{path:h,found:!0};for(const{dx:y,dy:u}of d){const E=f+y,m=a+u;if(this.isValidPoint(t,E,m)&&!c[m][E]){c[m][E]=!0;const v=[...h,{x:E,y:m}];o.push({x:E,y:m,path:v})}}}return{path:[],found:!1}}isValidPoint(t,e,i){return e>=0&&i>=0&&e<t.width&&i<t.height&&t.grid[i][e]}}class k{constructor(){x(this,"lastFrame",null);x(this,"referencePoints",[]);x(this,"transformMatrix",null)}initialize(t,e){this.lastFrame=t,this.extractReferencePoints(e)}track(t){if(!this.lastFrame||this.referencePoints.length===0)return null;const e=this.findFeatureMatches(t);return e.length<4?null:(this.transformMatrix=this.calculateHomography(this.referencePoints.slice(0,e.length),e),this.lastFrame=t,this.transformMatrix)}extractReferencePoints(t){this.referencePoints=[{x:0,y:0},{x:t.width-1,y:0},{x:t.width-1,y:t.height-1},{x:0,y:t.height-1}];const e=Math.max(30,Math.floor(Math.min(t.width,t.height)/10));for(let i=e;i<t.width-e;i+=e)this.referencePoints.push({x:i,y:0}),this.referencePoints.push({x:i,y:t.height-1});for(let i=e;i<t.height-e;i+=e)this.referencePoints.push({x:0,y:i}),this.referencePoints.push({x:t.width-1,y:i})}findFeatureMatches(t){const e=Math.floor(Math.random()*5)-2,i=Math.floor(Math.random()*5)-2;return this.referencePoints.map(n=>({x:Math.min(Math.max(0,n.x+e),t.width-1),y:Math.min(Math.max(0,n.y+i),t.height-1)}))}calculateHomography(t,e){if(t.length<4||e.length<4)return[1,0,0,0,1,0,0,0,1];let i=0,n=0;for(let c=0;c<t.length;c++)i+=e[c].x-t[c].x,n+=e[c].y-t[c].y;const r=i/t.length,o=n/t.length;return[1,0,r,0,1,o,0,0,1]}transformPoint(t){if(!this.transformMatrix)return t;const[e,i,n,r,o,c,d,f,a]=this.transformMatrix,h=d*t.x+f*t.y+a;return{x:(e*t.x+i*t.y+n)/h,y:(r*t.x+o*t.y+c)/h}}transformPath(t){return t.map(e=>this.transformPoint(e))}}class O{constructor(){x(this,"tracker");x(this,"canvas");x(this,"ctx");x(this,"maze",null);x(this,"solution",null);x(this,"isTracking",!1);this.tracker=new k,this.canvas=document.getElementById("overlay"),this.ctx=this.canvas.getContext("2d")}initialize(t,e,i){this.maze=e,this.solution=i,this.tracker.initialize(t,e),this.isTracking=!0}startProjection(){this.isTracking=!0,this.update()}stopProjection(){this.isTracking=!1}update(t){!this.isTracking||!this.maze||!this.solution||!this.solution.found||(t&&this.tracker.track(t),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.drawTransformedSolution(),this.isTracking&&requestAnimationFrame(()=>this.update()))}drawTransformedSolution(){if(!this.solution||!this.solution.found)return;const t=this.tracker.transformPath(this.solution.path);this.ctx.beginPath(),this.ctx.moveTo(t[0].x,t[0].y);for(let e=1;e<t.length;e++)this.ctx.lineTo(t[e].x,t[e].y);this.ctx.strokeStyle="rgba(0, 255, 255, 0.8)",this.ctx.lineWidth=6,this.ctx.lineCap="round",this.ctx.lineJoin="round",this.ctx.stroke(),this.ctx.strokeStyle="rgba(255, 255, 255, 0.9)",this.ctx.lineWidth=2,this.ctx.stroke(),t.length>0&&(this.drawARPoint(t[0],"rgba(0, 255, 0, 0.8)"),this.drawARPoint(t[t.length-1],"rgba(255, 0, 0, 0.8)"))}drawARPoint(t,e){this.ctx.beginPath(),this.ctx.arc(t.x,t.y,15,0,Math.PI*2),this.ctx.fillStyle=e.replace("0.8","0.3"),this.ctx.fill(),this.ctx.beginPath(),this.ctx.arc(t.x,t.y,8,0,Math.PI*2),this.ctx.fillStyle=e,this.ctx.fill(),this.ctx.beginPath(),this.ctx.arc(t.x,t.y,3,0,Math.PI*2),this.ctx.fillStyle="white",this.ctx.fill()}}class L{constructor(){x(this,"canvas");x(this,"ctx");this.canvas=document.getElementById("overlay"),this.ctx=this.canvas.getContext("2d")}clear(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}drawMaze(t){this.clear(),this.ctx.fillStyle="rgba(40, 40, 100, 0.5)",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.globalCompositeOperation="destination-out";for(let e=0;e<t.height;e++)for(let i=0;i<t.width;i++)t.grid[e][i]&&this.ctx.fillRect(i,e,1,1);this.ctx.globalCompositeOperation="source-over",t.start&&this.drawPoint(t.start,"rgba(0, 255, 0, 0.7)","START"),t.end&&this.drawPoint(t.end,"rgba(255, 0, 0, 0.7)","END")}drawSolution(t){if(!(!t.found||t.path.length<2)){this.ctx.strokeStyle="rgba(255, 42, 109, 0.8)",this.ctx.lineWidth=5,this.ctx.lineCap="round",this.ctx.lineJoin="round",this.ctx.beginPath(),this.ctx.moveTo(t.path[0].x,t.path[0].y);for(let e=1;e<t.path.length;e++)this.ctx.lineTo(t.path[e].x,t.path[e].y);this.ctx.stroke()}}drawPoint(t,e,i){this.ctx.beginPath(),this.ctx.arc(t.x,t.y,10,0,Math.PI*2),this.ctx.fillStyle=e,this.ctx.fill(),this.ctx.strokeStyle="white",this.ctx.lineWidth=2,this.ctx.stroke(),i&&(this.ctx.fillStyle="white",this.ctx.font="bold 14px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="bottom",this.ctx.fillText(i,t.x,t.y-15))}drawSelectionHint(t){const e=this.canvas.width/2,i=30;this.ctx.fillStyle="rgba(0, 0, 0, 0.7)",this.ctx.fillRect(0,0,this.canvas.width,60),this.ctx.fillStyle="white",this.ctx.font="bold 18px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(t,e,i)}}var l=(s=>(s.IDLE="idle",s.CAMERA_READY="camera_ready",s.DETECTING="detecting",s.SELECTING_START="selecting_start",s.SELECTING_END="selecting_end",s.SOLVING="solving",s.SOLUTION_READY="solution_ready",s.ERROR="error",s))(l||{});document.addEventListener("DOMContentLoaded",()=>{const s=document.getElementById("start-btn"),t=document.getElementById("solve-btn"),e=document.getElementById("status-text"),i=document.getElementById("overlay");let n=l.IDLE,r=null,o=null,c=null,d=!1;const f=new D,a=new N,h=new L,y=new O,u=(g,w)=>{switch(n=g,g){case l.IDLE:e.textContent="Ready to start",s.disabled=!1,t.disabled=!0;break;case l.CAMERA_READY:e.textContent="Camera ready! Point at a maze and press Solve",s.disabled=!0,t.disabled=!1;break;case l.DETECTING:e.textContent="Processing maze...",t.disabled=!0;break;case l.SELECTING_START:e.textContent="Tap on the screen to set START point",t.disabled=!0,h.drawSelectionHint("Tap to set START point");break;case l.SELECTING_END:e.textContent="Tap on the screen to set END point",t.disabled=!0,h.drawSelectionHint("Tap to set END point");break;case l.SOLVING:e.textContent="Solving maze...",t.disabled=!0;break;case l.SOLUTION_READY:e.textContent="Solution found! Move camera to see AR projection",t.textContent=d?"Reset":"Project Solution",t.disabled=!1;break;case l.ERROR:e.textContent=w||"An error occurred",s.disabled=!1,t.disabled=!0;break}},E=()=>{!r||!o||!c||(d=!0,u(l.SOLUTION_READY),y.initialize(c,r,o),y.startProjection(),m())},m=()=>{d&&(c=b(),y.update(c),requestAnimationFrame(m))},v=()=>{d=!1,y.stopProjection(),t.textContent="Project Solution"};i.addEventListener("click",g=>{if(!r||d)return;const w=i.getBoundingClientRect(),P=g.clientX-w.left,p=g.clientY-w.top,M=i.width/w.width,S=i.height/w.height,T={x:P*M,y:p*S};n===l.SELECTING_START?(r.start=T,h.drawMaze(r),u(l.SELECTING_END)):n===l.SELECTING_END&&(r.end=T,h.drawMaze(r),u(l.SOLVING),setTimeout(()=>{r&&(o=a.solveMaze(r),o.found?(h.drawSolution(o),u(l.SOLUTION_READY)):u(l.ERROR,"No solution found. Try different points."))},500))}),s.addEventListener("click",async()=>{try{u(l.DETECTING,"Starting camera..."),await A(),u(l.CAMERA_READY)}catch(g){g instanceof Error?u(l.ERROR,`Error: ${g.message}`):u(l.ERROR,"An unknown error occurred"),console.error("Camera setup error:",g)}}),t.addEventListener("click",()=>{if(n===l.SOLUTION_READY){d?(v(),h.clear(),r=null,o=null,u(l.CAMERA_READY)):E();return}u(l.DETECTING),h.clear(),r=null,o=null,c=b(),setTimeout(()=>{try{c&&(r=f.detectMaze(c),h.drawMaze(r),u(l.SELECTING_START))}catch(g){console.error("Error processing maze:",g),u(l.ERROR,"Error processing image. Please try again.")}},1e3)})});
